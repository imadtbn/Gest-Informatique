<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØªØ¬Ø± Ø§Ù„Ø³Ù„Ø¹ Ø§Ù„Ø·Ø§Ø²Ø¬Ø© â€” Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø©</title>
    <meta name="description" content="Ù…ØªØ¬Ø± Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ© Ù…ØªØµÙ„ Ø¨Google SheetsØŒ Ø¨Ø­Ø« Ø¹Ø±Ø¨ÙŠØŒ Ø³Ù„Ø© Ø°ÙƒÙŠØ©ØŒ ØªÙˆØµÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©.">
    <style>
    :root{
        --primary:#4CAF50;
        --accent:#FF9800;
        --muted:#f4f4f9;
        --danger:#e64a19;
        --panel-bg:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, 'Arial', sans-serif;background:var(--muted);color:#222;direction:rtl}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:var(--panel-bg);position:sticky;top:0;z-index:1200;box-shadow:0 2px 6px rgba(0,0,0,.06);gap:12px}
    .logo{font-weight:700;color:var(--primary);font-size:20px;min-width:140px}
    .search-bar{display:flex;flex:1;max-width:720px;gap:8px}
    #search-input{flex:1;padding:10px;border:1px solid #e6e6e6;border-radius:8px}
    .search-bar button{padding:10px 14px;border-radius:8px;border:none;background:var(--primary);color:#fff;cursor:pointer}
    .cart-container{display:flex;align-items:center;gap:10px;background:#fafafa;padding:6px 10px;border-radius:10px;border:1px solid #eee}
    .cart-total{font-weight:700;color:var(--danger)}
    .cart-count{font-size:13px;color:#666}
    .cart-icon{position:relative;cursor:pointer;padding:6px}
    #cart-badge{position:absolute;top:-6px;left:-6px;background:red;color:#fff;border-radius:50%;padding:2px 6px;font-size:12px}

    main{padding:20px}
    .category-section h2{color:var(--primary);border-bottom:2px solid #eee;padding-bottom:8px;margin:26px 0 8px}
    .product-grid{display:flex;flex-wrap:wrap;gap:18px}
    .product-card{width:250px;background:var(--panel-bg);border-radius:10px;padding:12px;border:1px solid #eee;box-shadow:0 4px 12px rgba(0,0,0,.03);text-align:center;transition:transform .18s}
    .product-card:hover{transform:translateY(-6px)}
    .product-card img{width:100%;height:150px;object-fit:contain;border-radius:6px;margin-bottom:8px}
    .product-info h3{font-size:16px;margin:6px 0}
    .price{font-weight:700;color:var(--danger);margin-top:6px}
    .add-to-cart-btn{margin-top:10px;background:var(--accent);color:#fff;border:none;padding:10px;border-radius:8px;width:100%;cursor:pointer}

    /* sidebar & overlay */
    #overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);z-index:1100;display:none}
    .panel{position:fixed;top:0;right:0;width:380px;height:100%;background:var(--panel-bg);box-shadow:-8px 0 24px rgba(0,0,0,.12);padding:20px;overflow:auto;z-index:1150;transform:translateX(100%);transition:transform .25s ease}
    .panel.open{transform:translateX(0)}
    .panel .close{background:#eee;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}

    /* floating cart button */
    #floating-cart{position:fixed;bottom:20px;left:20px;background:var(--primary);color:#fff;padding:12px 16px;border-radius:999px;box-shadow:0 6px 18px rgba(0,0,0,.16);z-index:1300;cursor:pointer;display:none}

    /* responsive */
    @media(max-width:768px){
        .product-card{width:100%;max-width:420px}
        #floating-cart{display:block}
        header{padding:10px}
    }

    footer{background:#222;color:#ddd;text-align:center;padding:18px;margin-top:30px}

    /* toast */
    #toast{position:fixed;top:24px;right:24px;background:var(--primary);color:#fff;padding:12px 16px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.12);z-index:1400;opacity:0;transform:translateY(-6px);transition:opacity .25s,transform .25s}
    #toast.show{opacity:1;transform:translateY(0)}

    /* small admin area */
    #admin-panel{position:fixed;bottom:20px;right:20px;background:#fff;padding:10px;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,.08);z-index:1600}
    #admin-panel input{width:300px;padding:8px;border:1px solid #eee;border-radius:6px}
    #admin-panel button{margin-top:6px;padding:8px 10px;border-radius:6px;border:none;background:var(--primary);color:#fff;cursor:pointer}
    </style>
</head>
<body>
    <header>
        <div class="logo">Ù…ØªØ¬Ø± Ø§Ù„Ø³Ù„Ø¹ Ø§Ù„Ø·Ø§Ø²Ø¬Ø©</div>
        <div class="search-bar">
            <input id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ØŒ ØµÙ†Ù Ø£Ùˆ ÙƒÙ„Ù…Ø©..." />
            <button id="search-btn">Ø¨Ø­Ø«</button>
        </div>
        <div class="cart-container">
            <div class="cart-info">
                <div class="cart-total" id="header-cart-total">0 Ø¯Ø¬</div>
                <div class="cart-count" id="header-cart-count">0 Ù…Ù†ØªØ¬</div>
            </div>
            <div class="cart-icon" id="cart-icon" title="Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©">
                <span id="cart-badge">0</span>
                ğŸ§º
            </div>
        </div>
    </header>

    <main id="main-content">
        <!-- Products injected here -->
        <div id="loader" style="text-align:center;padding:40px">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</div>
    </main>

    <div id="overlay"></div>

    <aside id="cart-sidebar" class="panel" aria-hidden="true">
        <button class="close" id="close-cart">Ø¥ØºÙ„Ø§Ù‚</button>
        <h3>Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
        <div id="cart-items" style="margin-top:12px"></div>
        <div class="summary" style="margin-top:18px;border-top:1px dashed #eee;padding-top:12px">
            <p>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ: <strong id="sub-total">0 Ø¯Ø¬</strong></p>
            <p>ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„: <strong id="delivery-cost">0 Ø¯Ø¬</strong></p>
            <p class="total">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: <strong id="grand-total">0 Ø¯Ø¬</strong></p>
        </div>
        <button id="checkout-button" style="margin-top:12px;background:var(--primary);color:#fff;padding:10px;border:none;border-radius:8px;width:100%;cursor:pointer">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡</button>
    </aside>

    <section id="checkout-form" class="panel" style="width:380px">
        <button class="close" id="close-checkout">Ø¥ØºÙ„Ø§Ù‚</button>
        <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</h3>
        <input type="text" id="customer-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required style="width:100%;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #eee" />
        <input type="tel" id="customer-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required style="width:100%;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #eee" />
        <button id="get-location-btn" style="margin-top:10px;width:100%;padding:10px;border-radius:6px;border:none;background:#2196F3;color:#fff;cursor:pointer">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</button>
        <p id="location-status" style="color:#444;margin-top:8px"></p>
        <p class="total">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ Ù…Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„: <strong id="final-total">0 Ø¯Ø¬</strong></p>
        <button id="send-whatsapp-order" style="width:100%;padding:10px;border-radius:6px;border:none;background:#25D366;color:#fff;cursor:pointer">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button id="back-to-cart" style="width:100%;padding:10px;border-radius:6px;border:none;background:#eee;color:#333;cursor:pointer;margin-top:8px">Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©</button>
    </section>

    <div id="toast"></div>

    <button id="floating-cart" title="Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©">ğŸ§º Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ <span id="float-badge" style="margin-inline-start:8px;background:red;padding:2px 6px;border-radius:999px;font-size:12px">0</span></button>

    <div id="admin-panel">
        <div style="font-size:12px;color:#666">Admin: Products API</div>
        <input id="admin-api" placeholder="URL Google Apps Script (doGet)" />
        <div style="display:flex;gap:6px;margin-top:6px">
            <button id="save-api">Ø­ÙØ¸</button>
            <button id="clear-cache" style="background:#e64a19;color:#fff;border:none;padding:8px;border-radius:6px;cursor:pointer">Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´</button>
        </div>
    </div>

    <footer>
        &copy; 2025 Ù…ØªØ¬Ø± Ø§Ù„Ø³Ù„Ø¹ Ø§Ù„Ø·Ø§Ø²Ø¬Ø© â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.
    </footer>

    <script>
    // ======= CONFIG =======
    const PRODUCTS_API = localStorage.getItem('admin_api_url') || '';
    const CACHE_KEY = 'products_cache_v2';
    const CACHE_TS_KEY = 'products_cache_ts_v2';
    const CACHE_TTL_MS = 1000 * 60 * 10; // 10 minutes

    // Ø«Ø§Ø¨Øª Ø§Ù„Ù…ØªØ¬Ø± (Ù…Ø«Ø§Ù„: Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„Ø¹Ø§ØµÙ…Ø©)
    const STORE_LAT = 36.7538;
    const STORE_LON = 3.0588;

    // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    let products = [];
    let cart = [];
    let customerLocation = null;
    let deliveryCost = 0;

    // ======= Utilities =======
    function normalizeArabic(str = ''){
        return String(str).trim().normalize('NFKC')
            .replace(/[Ù‹-Ù’]/g, '')
            .replace(/[Ø¥Ø£Ø¢]/g,'Ø§')
            .replace(/Ù‰/g,'ÙŠ')
            .replace(/Ø¤/g,'Ùˆ')
            .replace(/Ø¦/g,'ÙŠ')
            .replace(/Ø©/g,'Ù‡')
            .toLowerCase();
    }

    function showToast(text, duration = 2500){
        const t = document.getElementById('toast');
        t.textContent = text;
        t.classList.add('show');
        setTimeout(()=>t.classList.remove('show'), duration);
    }

    function formatPrice(num){
        return Number(num || 0).toLocaleString() + ' Ø¯Ø¬';
    }

    // ======= Fetch products (from Google Apps Script / API) =======
    async function fetchProducts(ignoreCache = false){
        // load from cache first if exists and fresh
        try{
            const cached = localStorage.getItem(CACHE_KEY);
            const ts = Number(localStorage.getItem(CACHE_TS_KEY) || 0);
            const age = Date.now() - ts;
            if(!ignoreCache && cached && age < CACHE_TTL_MS){
                products = JSON.parse(cached);
                renderProducts(products);
            }
        }catch(e){console.warn('cache read error', e)}

        // if no API configured, use fallback
        const api = localStorage.getItem('admin_api_url') || PRODUCTS_API;
        if(!api){
            console.warn('No PRODUCTS_API configured, using fallback dataset');
            products = getFallbackProducts();
            localStorage.setItem(CACHE_KEY, JSON.stringify(products));
            localStorage.setItem(CACHE_TS_KEY, Date.now());
            renderProducts(products);
            return;
        }

        try{
            const res = await fetch(api, { method: 'GET' });
            if(!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();

            // map external fields to Arabic keys used in app
            products = (Array.isArray(data) ? data : []).map(row=>{
                const priceNum = Number(String(row.price ?? row.Ø³Ø¹Ø± ?? 0).replace(/[^0-9.-]/g,'')) || 0;
                return {
                    id: String(row.id ?? row.ID ?? row.Id ?? '').trim() || String(Math.random()).slice(2),
                    ØµÙ†Ù: String(row.category ?? row.ØµÙ†Ù ?? row.category_name ?? '').trim(),
                    Ø§Ø³Ù…: String(row.name ?? row.Ø§Ø³Ù… ?? '').trim(),
                    Ø³Ø¹Ø±: priceNum,
                    ÙƒÙ„Ù…Ø§Øª_Ù…ÙØªØ§Ø­ÙŠØ©: String(row.keywords ?? row.ÙƒÙ„Ù…Ø§Øª_Ù…ÙØªØ§Ø­ÙŠØ© ?? '').trim(),
                    ØµÙˆØ±Ø©: String(row.image ?? row.ØµÙˆØ±Ø© ?? '').trim() || 'https://via.placeholder.com/250x150?text=No+Image'
                };
            });

            // cache
            localStorage.setItem(CACHE_KEY, JSON.stringify(products));
            localStorage.setItem(CACHE_TS_KEY, Date.now());

            renderProducts(products);
        }catch(err){
            console.error('fetchProducts error', err);
            showToast('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª â€” Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©', 3000);
            products = getFallbackProducts();
            renderProducts(products);
        }
    }

    function getFallbackProducts(){
        return [
            { id:'P001', ØµÙ†Ù:'Ø²ÙŠØª Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', Ø§Ø³Ù…:'Ø²ÙŠØª Ø¹Ø¨Ø§Ø¯ Ø§Ù„Ø´Ù…Ø³ 5 Ù„ØªØ±', Ø³Ø¹Ø±:2500, ÙƒÙ„Ù…Ø§Øª_Ù…ÙØªØ§Ø­ÙŠØ©:'Ø²ÙŠØªØŒØ·Ø¨Ø®', ØµÙˆØ±Ø©:'https://via.placeholder.com/250x150?text=Ø²ÙŠØª+5Ù„ØªØ±' },
            { id:'P002', ØµÙ†Ù:'Ø²ÙŠØª Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', Ø§Ø³Ù…:'Ø²ÙŠØª Ø¹Ø¨Ø§Ø¯ Ø§Ù„Ø´Ù…Ø³ 2 Ù„ØªØ±', Ø³Ø¹Ø±:1000, ÙƒÙ„Ù…Ø§Øª_Ù…ÙØªØ§Ø­ÙŠØ©:'Ø²ÙŠØªØŒØ·Ø¨Ø®', ØµÙˆØ±Ø©:'https://via.placeholder.com/250x150?text=Ø²ÙŠØª+2Ù„ØªØ±' },
            { id:'P003', ØµÙ†Ù:'Ø§Ù„Ù…Ø¹Ù„Ø¨Ø§Øª', Ø§Ø³Ù…:'Ø¹Ù„Ø¨Ø© ØªÙˆÙ†Ø© Ø¨Ø§Ù„Ø²ÙŠØª', Ø³Ø¹Ø±:150, ÙƒÙ„Ù…Ø§Øª_Ù…ÙØªØ§Ø­ÙŠØ©:'ØªÙˆÙ†Ø©ØŒØ³Ù…Ùƒ', ØµÙˆØ±Ø©:'https://via.placeholder.com/250x150?text=ØªÙˆÙ†Ø©' },
            { id:'P004', ØµÙ†Ù:'Ø§Ù„Ø­Ø¨ÙˆØ¨', Ø§Ø³Ù…:'Ø£Ø±Ø² Ø¨Ø³Ù…ØªÙŠ 5 ÙƒØºÙ…', Ø³Ø¹Ø±:1200, ÙƒÙ„Ù…Ø§Øª_Ù…ÙØªØ§Ø­ÙŠØ©:'Ø§Ø±Ø²ØŒØ­Ø¨ÙˆØ¨', ØµÙˆØ±Ø©:'https://via.placeholder.com/250x150?text=Ø§Ø±Ø²' },
            { id:'P005', ØµÙ†Ù:'Ø§Ù„Ø­Ø¨ÙˆØ¨', Ø§Ø³Ù…:'Ø¹Ø¯Ø³ Ø£ØµÙØ± 1 ÙƒØºÙ…', Ø³Ø¹Ø±:300, ÙƒÙ„Ù…Ø§Øª_Ù…ÙØªØ§Ø­ÙŠØ©:'Ø¹Ø¯Ø³ØŒØ­Ø¨ÙˆØ¨', ØµÙˆØ±Ø©:'https://via.placeholder.com/250x150?text=Ø¹Ø¯Ø³' }
        ];
    }

    // ======= Render =======
    function renderProducts(list){
        const main = document.getElementById('main-content');
        main.innerHTML = '';
        if(!list || list.length === 0){
            main.innerHTML = '<p style="text-align:center;padding:40px;color:#666">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
            return;
        }

        const categories = {};
        list.forEach(p=>{ categories[p.ØµÙ†Ù] = categories[p.ØµÙ†Ù] || []; categories[p.ØµÙ†Ù].push(p); });

        Object.keys(categories).forEach((cat, idx, arr)=>{
            const section = document.createElement('section');
            section.className = 'category-section';
            const heading = document.createElement('h2'); heading.textContent = cat || 'Ø¹Ø§Ù…'; section.appendChild(heading);

            const grid = document.createElement('div'); grid.className = 'product-grid';
            categories[cat].forEach(prod=>{
                const card = document.createElement('div'); card.className = 'product-card';
                card.innerHTML = `
                    <img loading="lazy" src="${prod.ØµÙˆØ±Ø©}" alt="${prod.Ø§Ø³Ù…}" onerror="this.src='https://via.placeholder.com/250x150?text=No+Image'">
                    <div class="product-info">
                        <h3>${prod.Ø§Ø³Ù…}</h3>
                        <div style="color:#666;font-size:13px">Ø§Ù„ØµÙ†Ù: ${prod.ØµÙ†Ù}</div>
                        <div class="price">${formatPrice(prod.Ø³Ø¹Ø±)}</div>
                    </div>
                    <button class="add-to-cart-btn" data-product-id="${prod.id}">â• Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©</button>
                `;
                grid.appendChild(card);
            });

            section.appendChild(grid);
            main.appendChild(section);
            if(idx < arr.length -1){ const hr = document.createElement('hr'); main.appendChild(hr); }
        });

        // attach listeners
        document.querySelectorAll('.add-to-cart-btn').forEach(btn=>{
            btn.addEventListener('click', e=>{
                const id = btn.getAttribute('data-product-id');
                handleAddToCart(id);
            });
        });
    }

    // ======= Cart logic =======
    function handleAddToCart(productId){
        const product = products.find(p=>p.id === productId);
        if(!product) return;
        const existing = cart.find(i=>i.id === productId);
        if(existing) existing.quantity += 1; else cart.push({ id:product.id, Ø§Ø³Ù…:product.Ø§Ø³Ù…, Ø³Ø¹Ø±:Number(product.Ø³Ø¹Ø±), quantity:1, ØµÙ†Ù:product.ØµÙ†Ù });
        updateCartDisplay();
        showToast(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${product.Ø§Ø³Ù…} Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©`);
    }

    function updateCartDisplay(){
        const subTotal = cart.reduce((t,i)=>t + (Number(i.Ø³Ø¹Ø±) * i.quantity), 0);
        document.getElementById('header-cart-total').textContent = formatPrice(subTotal);
        const totalCount = cart.reduce((t,i)=>t + i.quantity, 0);
        document.getElementById('header-cart-count').textContent = totalCount + ' Ù…Ù†ØªØ¬';
        document.getElementById('cart-badge').textContent = totalCount;
        document.getElementById('float-badge').textContent = totalCount;

        const itemsContainer = document.getElementById('cart-items'); itemsContainer.innerHTML = '';
        if(cart.length === 0){ itemsContainer.innerHTML = '<p>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p>'; }
        else{
            cart.forEach(item=>{
                const el = document.createElement('div'); el.className = 'cart-item';
                el.style.display='flex'; el.style.justifyContent='space-between'; el.style.marginBottom='12px';
                el.innerHTML = `
                    <div style="flex:1">
                        <strong>${item.Ø§Ø³Ù…}</strong>
                        <div class="quantity-control" style="display:flex;gap:8px;align-items:center;margin-top:6px">
                            <button class="quantity-minus" data-product-id="${item.id}">-</button>
                            <span class="current-quantity">${item.quantity}</span>
                            <button class="quantity-plus" data-product-id="${item.id}">+</button>
                        </div>
                    </div>
                    <div style="min-width:80px;text-align:left">${formatPrice(item.Ø³Ø¹Ø± * item.quantity)}</div>
                `;
                itemsContainer.appendChild(el);
            });

            // listeners
            document.querySelectorAll('.quantity-minus').forEach(btn=>btn.addEventListener('click', e=>{
                const id = btn.getAttribute('data-product-id'); handleQuantityChange(id, -1);
            }));
            document.querySelectorAll('.quantity-plus').forEach(btn=>btn.addEventListener('click', e=>{
                const id = btn.getAttribute('data-product-id'); handleQuantityChange(id, 1);
            }));
        }

        document.getElementById('sub-total').textContent = formatPrice(subTotal);
        const grandTotal = subTotal + deliveryCost;
        document.getElementById('grand-total').textContent = formatPrice(grandTotal);
        document.getElementById('final-total').textContent = formatPrice(grandTotal);
        document.getElementById('delivery-cost').textContent = formatPrice(deliveryCost);
    }

    function handleQuantityChange(productId, delta){
        const item = cart.find(i=>i.id === productId);
        if(!item) return;
        item.quantity += delta;
        if(item.quantity <= 0){ cart = cart.filter(i=>i.id !== productId); showToast(`ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© ${item.Ø§Ø³Ù…} Ù…Ù† Ø§Ù„Ø³Ù„Ø©`); }
        updateCartDisplay();
    }

    // ======= Search =======
    function setupSearch(){
        const input = document.getElementById('search-input');
        const btn = document.getElementById('search-btn');
        const perform = ()=>{
            const term = normalizeArabic(input.value);
            if(!term) return renderProducts(products);
            const filtered = products.filter(p=>{
                return normalizeArabic(p.Ø§Ø³Ù…).includes(term) || normalizeArabic(p.ØµÙ†Ù).includes(term) || normalizeArabic(p.ÙƒÙ„Ù…Ø§Øª_Ù…ÙØªØ§Ø­ÙŠØ©).includes(term);
            });
            renderProducts(filtered);
        };
        input.addEventListener('input', perform);
        btn.addEventListener('click', perform);
    }

    // ======= Location & Delivery calculation =======
    function calculateDistance(lat1, lon1, lat2, lon2){
        const R = 6371; const dLat = (lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R*c;
    }

    function setupLocation(){
        document.getElementById('get-location-btn').addEventListener('click', ()=>{
            if(!navigator.geolocation){ alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.'); return; }
            navigator.geolocation.getCurrentPosition(pos=>{
                customerLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                const km = calculateDistance(STORE_LAT, STORE_LON, customerLocation.lat, customerLocation.lon);
                const BASE_FEE = 300; const FREE_DISTANCE = 5; const RATE_PER_KM = 50;
                deliveryCost = Math.round(BASE_FEE + Math.max(0, km - FREE_DISTANCE) * RATE_PER_KM);
                document.getElementById('location-status').textContent = `âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. Ø§Ù„Ù…Ø³Ø§ÙØ©: ${km.toFixed(2)} ÙƒÙ….`;
                updateCartDisplay();
            }, err=>{
                console.warn(err);
                deliveryCost = 500;
                document.getElementById('location-status').textContent = `âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. Ø±Ø³ÙˆÙ… ØªÙˆØµÙŠÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ${formatPrice(deliveryCost)}`;
                updateCartDisplay();
            });
        });
    }

    // ======= WhatsApp integration =======
    function setupWhatsApp(){
        document.getElementById('send-whatsapp-order').addEventListener('click', ()=>{
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            if(!name || !phone){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.'); return; }
            if(!customerLocation){ alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆØµÙŠÙ„.'); return; }
            if(cart.length === 0){ alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©. Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª.'); return; }

            let orderDetails = '';
            cart.forEach(item=>{ orderDetails += `- ${item.Ø§Ø³Ù…} (${item.quantity} Ã— ${formatPrice(item.Ø³Ø¹Ø±)}) = ${formatPrice(item.Ø³Ø¹Ø± * item.quantity)}
`; });
            const subTotal = cart.reduce((t,i)=>t + i.Ø³Ø¹Ø±*i.quantity,0);
            const totalCost = subTotal + deliveryCost;

            const message = `Ø·Ù„Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© - Ù…ØªØ¬Ø± Ø§Ù„Ø³Ù„Ø¹ Ø§Ù„Ø·Ø§Ø²Ø¬Ø©

Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ†:
- Ø§Ù„Ø§Ø³Ù…: ${name}
- Ø§Ù„Ù‡Ø§ØªÙ: ${phone}

ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:
${orderDetails}
Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ: ${formatPrice(subTotal)}
ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„: ${formatPrice(deliveryCost)}
Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: ${formatPrice(totalCost)}

Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„: https://www.google.com/maps/search/?api=1&query=${customerLocation.lat},${customerLocation.lon}`;

            const encoded = encodeURIComponent(message);
            // TODO: Ø¶Ø¹ Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¬Ø± Ù‡Ù†Ø§ Ø¨ØµÙŠØºØ© Ø¯ÙˆÙ„ÙŠØ© Ø¨Ø¯ÙˆÙ† +ØŒ Ù…Ø«Ø§Ù„: 213XXXXXXXXX
            const shopNumber = localStorage.getItem('shop_phone') || '213123456789';
            const waUrl = `https://wa.me/${shopNumber}?text=${encoded}`;
            window.open(waUrl, '_blank');
        });
    }

    // ======= UI Handlers =======
    function setupUI(){
        const cartIcon = document.getElementById('cart-icon');
        const overlay = document.getElementById('overlay');
        const cartSidebar = document.getElementById('cart-sidebar');
        const checkoutPanel = document.getElementById('checkout-form');
        const closeCart = document.getElementById('close-cart');
        const closeCheckout = document.getElementById('close-checkout');
        const floating = document.getElementById('floating-cart');

        function openPanel(panel){ overlay.style.display='block'; panel.classList.add('open'); panel.setAttribute('aria-hidden','false'); }
        function closePanel(panel){ panel.classList.remove('open'); panel.setAttribute('aria-hidden','true'); overlay.style.display='none'; }

        cartIcon.addEventListener('click', ()=> openPanel(cartSidebar));
        floating.addEventListener('click', ()=> openPanel(cartSidebar));
        closeCart.addEventListener('click', ()=> closePanel(cartSidebar));
        closeCheckout.addEventListener('click', ()=> closePanel(checkoutPanel));
        overlay.addEventListener('click', ()=>{ closePanel(cartSidebar); closePanel(checkoutPanel); });

        document.getElementById('checkout-button').addEventListener('click', ()=>{
            if(cart.length === 0){ alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©.'); return; }
            closePanel(cartSidebar); openPanel(checkoutPanel);
        });

        document.getElementById('back-to-cart').addEventListener('click', ()=>{ closePanel(checkoutPanel); openPanel(cartSidebar); });
    }

    // ======= Admin panel =======
    function setupAdmin(){
        const input = document.getElementById('admin-api');
        const saveBtn = document.getElementById('save-api');
        const clearBtn = document.getElementById('clear-cache');
        input.value = localStorage.getItem('admin_api_url') || '';
        saveBtn.addEventListener('click', ()=>{
            const v = input.value.trim(); if(!v){ alert('Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· API ØµØ§Ù„Ø­.'); return; }
            localStorage.setItem('admin_api_url', v); showToast('ØªÙ… Ø­ÙØ¸ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API'); fetchProducts(true);
        });
        clearBtn.addEventListener('click', ()=>{ localStorage.removeItem(CACHE_KEY); localStorage.removeItem(CACHE_TS_KEY); showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´'); fetchProducts(true); });
    }

    // ======= Initialization =======
    document.addEventListener('DOMContentLoaded', ()=>{
        setupAdmin(); setupUI(); setupSearch(); setupLocation(); setupWhatsApp();
        // show floating cart on small screens
        if(window.innerWidth <= 768) document.getElementById('floating-cart').style.display = 'block';
        fetchProducts();
    });

    // ======= Accessibility / small helpers =======
    window.addEventListener('resize', ()=>{ if(window.innerWidth <= 768) document.getElementById('floating-cart').style.display = 'block'; else document.getElementById('floating-cart').style.display = 'none'; });
    </script>

    <!--
    Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù†Ø´Ø± Google Apps Script (doGet):
    - Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙŠØ¹ÙŠØ¯ JSON Ù…Ù† Google Sheets.
    - ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ (Anyone, even anonymous) Ø£Ùˆ Ø¥Ø¹Ø¯Ø§Ø¯ OAuth Ø¥Ø°Ø§ Ù„Ø²Ù….
    - Ù…Ø«Ø§Ù„ Ø¯Ø§Ù„Ø© doGet ÙÙŠ Apps Script:

    function doGet(e){
      const ss = SpreadsheetApp.openById('SPREADSHEET_ID');
      const sh = ss.getSheetByName('products');
      const rows = sh.getDataRange().getValues();
      const headers = rows.shift();
      const out = rows.map(r=>{
        const obj = {};
        headers.forEach((h,i)=> obj[h] = r[i]);
        return obj;
      });
      return ContentService.createTextOutput(JSON.stringify(out)).setMimeType(ContentService.MimeType.JSON).setHeader('Access-Control-Allow-Origin','*');
    }

    - ØªØ£ÙƒØ¯ Ø£Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ø´ÙŠØª ØªØªØ¶Ù…Ù†: id, name, category, price, keywords, image
    -->
</body>
</html>
